<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>智能农业决策支持系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <!-- 和风天气图标库 (可选, 如果需要显示天气图标) -->
  <link rel="stylesheet" href="https://unpkg.com/qweather-icons@1.1.1/font/qweather-icons.css">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #e0e0e0; /* 浅灰色文字，提高对比度 */
    }
    .tech-bg {
      background-color: #0a192f; /* 深蓝背景 */
      background-image: 
        linear-gradient(rgba(20, 83, 153, 0.08) 1.5px, transparent 1.5px), /* 更细的网格线，更淡的颜色 */
        linear-gradient(90deg, rgba(20, 83, 153, 0.08) 1.5px, transparent 1.5px);
      background-size: 30px 30px; /* 网格大小调整 */
      position: relative;
      min-height: 100vh;
      padding: 1rem; /* 统一padding */
      display: flex;
      flex-direction: column;
    }
    .tech-bg::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at center, rgba(10, 25, 47, 0.1) 0%, #0a192f 80%);
      pointer-events: none;
    }

    .main-container {
      display: grid;
      grid-template-columns: 2fr 5fr 3fr; /* 左中右三栏比例调整 */
      gap: 1rem; /* 面板间距 */
      width: 100%;
      max-width: 1600px; /* 页面最大宽度 */
      margin: auto; /* 居中 */
      flex-grow: 1; /* 占据剩余空间 */
    }

    .panel {
      background-color: rgba(13, 30, 51, 0.85); /* 面板背景色，更深邃 */
      border: 1px solid rgba(59, 130, 246, 0.3); /* 蓝色边框 */
      border-radius: 8px; /* 圆角 */
      padding: 1.5rem; /* 面板内边距 */
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.15); /* 更柔和的阴影 */
      backdrop-filter: blur(8px); /* 毛玻璃效果 */
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 4rem); /* 限制面板高度，防止溢出 */
    }
    .panel-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #60a5fa; /* 浅蓝色标题 */
      margin-bottom: 1rem;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      padding-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }
    .panel-title svg {
      margin-right: 0.5rem;
      width: 24px;
      height: 24px;
    }

    /* 左侧天气面板 */
    .weather-panel { grid-column: 1 / 2; }
    /* 中间交互面板 */
    .interaction-panel { 
        grid-column: 2 / 3; 
        display: flex; 
        flex-direction: column; 
        gap: 1rem; 
    }
    /* 让中间交互面板的直接子panel元素均分高度 */
    .interaction-panel > .panel {
        flex: 1; /* 均分可用垂直空间 */
        display: flex; /* 使其内部元素也可以使用flex布局 */
        flex-direction: column; /* 内部元素垂直排列 */
        min-height: 0; /* 防止内容过多时flex项目不会缩小，与flex:1配合使用 */
    }
    /* 确保图表容器能填充其父panel分配的空间 */
    .interaction-panel > .panel .chart-container {
        flex-grow: 1; /* 占据父flex容器中的剩余空间 */
        display: flex; /* 使canvas可以更好地居中或对齐 */
        align-items: center;
        justify-content: center;
        min-height: 200px; /* 给图表一个最小高度，防止过小 */
    }
    /* 对于包含表单的panel，确保表单部分不会无限收缩 */
    .interaction-panel > .panel form {
      /* 可以根据需要调整表单区域的伸缩行为，但通常表单高度由其内容决定 */
      /* 如果需要表单区域也参与flex伸缩，可以给它设置 flex-grow: 1 和 overflow-y: auto */
    }
    /* 右侧结果面板 */
    .results-panel { grid-column: 3 / 4; overflow-y: auto; }
    
    /* Chart.js 图表容器 */
    .chart-container {
      position: relative;
      height: 300px; /* 调整图表高度 */
      width: 100%;
      background-color: rgba(10, 25, 47, 0.5);
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    /* 输入和按钮样式 */
    select, input[type="text"], input[type="number"], textarea {
      background-color: rgba(10, 25, 47, 0.9); /* 输入框背景 */
      color: #cbd5e1; /* 输入框文字颜色 */
      border: 1px solid rgba(59, 130, 246, 0.4);
      border-radius: 4px;
      padding: 0.75rem 1rem;
      width: 100%;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    select:focus, input:focus, textarea:focus {
      border-color: #3b82f6; /* 亮蓝色焦点 */
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
      outline: none;
    }
    select option {
      background-color: #0a192f;
      color: #cbd5e1;
    }
    .gradient-btn {
      background: linear-gradient(45deg, #2563eb, #3b82f6); /* 按钮渐变 */
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase; /* 按钮文字大写 */
      letter-spacing: 0.5px; /* 字母间距 */
    }
    .gradient-btn:hover {
      background: linear-gradient(45deg, #1d4ed8, #2563eb); /* 悬停时更深的渐变 */
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
      transform: translateY(-1px);
    }
    .gradient-btn:disabled {
      background: #374151; /* 禁用状态 */
      cursor: not-allowed;
      opacity: 0.7;
    }
    .loading-spinner {
      display: inline-block;
      border: 3px solid rgba(59, 130, 246, 0.3);
      border-top-color: #3b82f6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem; /* 微调加载动画位置 */
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* 结果区域 Markdown 样式 */
    .markdown-content {
      font-size: 0.95rem;
      line-height: 1.7;
      color: #cbd5e1; /* Markdown内容颜色 */
    }
    .markdown-content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #60a5fa; /* 标题颜色 */
      margin-top: 1.25rem;
      margin-bottom: 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    }
    .markdown-content strong {
      color: #93c5fd; /* 强调文字颜色 */
    }
    .markdown-content ul {
      list-style-type: disc;
      margin-left: 1.5rem;
      padding-left: 0.5rem; /* 轻微调整列表缩进 */
    }
    .markdown-content li { margin-bottom: 0.3rem; }
    .markdown-content p { margin-bottom: 0.75rem; }
    .markdown-content code { /* 代码块样式 */
      background-color: rgba(10, 25, 47, 0.7);
      padding: 0.2em 0.4em;
      margin: 0;
      font-size: 85%;
      border-radius: 3px;
      color: #93c5fd;
    }
    .markdown-content pre code {
      display: block;
      padding: 0.5em;
      overflow-x: auto;
    }

    /* 天气图标 */
    .weather-icon { font-size: 4rem; color: #60a5fa; }

    /* 滚动条美化 (可选) */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(10, 25, 47, 0.5); border-radius:4px; }
    ::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius:4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(59, 130, 246, 0.8); }

    /* 页头 */
    .page-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .page-header h1 {
      font-size: 2.5rem; /* 标题字号调整 */
      font-weight: 700;
      color: #93c5fd; /* 主标题颜色 */
      letter-spacing: 1px;
      text-shadow: 0 0 10px rgba(59, 130, 246, 0.3); /* 标题阴影 */
    }
    .page-header .tech-title-main {
      display: inline-flex;
      align-items: center;
    }
    .page-header .tech-title-main::before, .page-header .tech-title-main::after {
      content: '';
      height: 2px; /* 装饰线条加粗 */
      width: 50px; /* 装饰线条加长 */
      background: linear-gradient(90deg, transparent, #3b82f6, transparent); /* 装饰线条渐变 */
      margin: 0 15px;
    }
    
    .data-source-ts {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.5rem;
      text-align: right;
    }

    /* 使预警结果区域可滚动 */
    #warningResultDisplay {
      max-height: 300px; /* 您可以根据实际内容调整这个高度 */
      overflow-y: auto; /* 当内容超出max-height时显示垂直滚动条 */
      padding: 0.75rem; /* 保持一些内边距，让内容不贴边 */
      border: 1px solid rgba(59, 130, 246, 0.2); /* 确保边框可见，与panel类似 */
      border-radius: 6px; /* 轻微圆角 */
      background-color: rgba(10, 25, 47, 0.7); /* 给滚动区域一个轻微背景以区分 */
    }
    /* 如果需要，可以为滚动条添加一些基础样式 (Webkit) */
    #warningResultDisplay::-webkit-scrollbar {
        width: 8px;
    }
    #warningResultDisplay::-webkit-scrollbar-track {
        background: rgba(10, 25, 47, 0.2);
        border-radius: 4px;
    }
    #warningResultDisplay::-webkit-scrollbar-thumb {
        background-color: rgba(59, 130, 246, 0.4);
        border-radius: 4px;
    }
    #warningResultDisplay::-webkit-scrollbar-thumb:hover {
        background-color: rgba(59, 130, 246, 0.6);
    }

  </style>
</head>
<body class="tech-bg">

  <header class="page-header">
    <h1>
      <svg class="inline-block h-10 w-10 text-blue-400 mr-3 align-middle" fill="none" viewBox="0 0 24 24" stroke="currentColor"  stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15a4.5 4.5 0 004.5 4.5H18a3.75 3.75 0 001.332-7.257 3 3 0 00-2.666-5.013 5.25 5.25 0 00-10.032 0 3.75 3.75 0 00-1.332 7.257H6.75A2.25 2.25 0 004.5 15zM12 12.75V16.5" />
      </svg>
      <span class="tech-title-main align-middle">智能农业决策支持系统</span>
    </h1>
  </header>

  <div class="main-container">
    <!-- 左侧：天气面板 -->
    <aside class="panel weather-panel">
      <h2 class="panel-title">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.513a8.96 8.96 0 016.085 2.797.75.75 0 01-.915 1.185A7.46 7.46 0 0012 6.75a7.46 7.46 0 00-6.92 4.995.75.75 0 11-.915-1.185 8.961 8.961 0 016.086-2.797V3a.75.75 0 01.75-.75zm2.532 6.42a.75.75 0 01.936.448l.876 2.043a.75.75 0 01-.448.936l-2.043.875a.75.75 0 01-.936-.448l-.875-2.043a.75.75 0 01.447-.936l2.043-.875zM2.034 13.02a.75.75 0 01.447-.936l2.043-.875a.75.75 0 01.936.448l.875 2.043a.75.75 0 01-.448.936l-2.043.875a.75.75 0 01-.936-.448l-.875-2.043a.75.75 0 01.001-.001zM12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5zM11.125 18a.75.75 0 01.75-.75h.25a.75.75 0 010 1.5h-.25a.75.75 0 01-.75-.75zM8.625 19.5a.75.75 0 01.75-.75h.25a.75.75 0 010 1.5h-.25a.75.75 0 01-.75-.75zM13.875 18a.75.75 0 01.75-.75h.25a.75.75 0 010 1.5h-.25a.75.75 0 01-.75-.75zM12 20.25a.75.75 0 01.75-.75h.25a.75.75 0 010 1.5h-.25a.75.75 0 01-.75-.75zM5.625 18a.75.75 0 01.75-.75h.25a.75.75 0 010 1.5h-.25a.75.75 0 01-.75-.75zM7.125 19.5a.75.75 0 01.75-.75h.25a.75.75 0 010 1.5h-.25a.75.75 0 01-.75-.75zM16.875 19.5a.75.75 0 01.75-.75h.25a.75.75 0 010 1.5h-.25a.75.75 0 01-.75-.75zM15.375 18a.75.75 0 01.75-.75h.25a.75.75 0 010 1.5h-.25a.75.75 0 01-.75-.75z"/></svg>
        天气实况
      </h2>
      <div id="weatherDisplay" class="text-center">
        <p id="weatherLoading">正在加载天气数据...</p>
        <!-- 天气数据将填充这里 -->
      </div>

      <!-- 新增：作物环境预警功能区域 -->
      <div id="cropWarningSection" class="mt-8 pt-6 border-t border-slate-700">
        <h3 class="panel-title text-lg mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path fill-rule="evenodd" d="M10.061 2.23a.75.75 0 01.878 0l2.68 1.837a.75.75 0 00.442.142h3.019a.75.75 0 01.713.965l-.82 2.458a.75.75 0 00.21.629l2.118 2.117a.75.75 0 010 .878l-2.118 2.118a.75.75 0 00-.21.629l.82 2.458a.75.75 0 01-.713.965h-3.02a.75.75 0 00-.442.142l-2.68 1.837a.75.75 0 01-.878 0l-2.68-1.837a.75.75 0 00-.442-.142H3.75a.75.75 0 01-.713-.965l.82-2.458a.75.75 0 00.21-.629L2.034 12.44a.75.75 0 010-.878l2.118-2.118a.75.75 0 00.21-.629l-.82-2.458a.75.75 0 01.713-.965h3.019a.75.75 0 00.442-.142l2.68-1.837zM9 6a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 019 6zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>
          作物环境预警
        </h3>
        <div class="space-y-3">
          <div>
            <label for="warning_crop_type" class="block text-sm font-medium text-slate-400 mb-1">选择作物进行预警评估</label>
            <select id="warning_crop_type" name="warning_crop_type" class="w-full">
              <option value="" disabled selected>正在加载作物列表...</option>
              <!-- 作物种类将由JS动态填充 -->
            </select>
          </div>
          <button id="fetchWarningBtn" class="w-full gradient-btn">
            <span class="button-text">获取预警评估</span>
            <div class="loading-spinner hidden ml-2"></div>
          </button>
        </div>
        <div id="warningResultDisplay" class="mt-4 p-3 bg-slate-800/50 border border-slate-700 rounded-md text-sm min-h-[100px]">
          <p id="warningPlaceholder" class="text-slate-500">请选择作物并点击按钮获取预警信息。</p>
          <!-- 预警结果将填充这里 -->
        </div>
      </div>
      <!-- 预警功能区域结束 -->
    </aside>

    <!-- 中间：交互面板和图表 -->
    <main class="interaction-panel">
      <div class="panel">
        <h2 class="panel-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 9a.75.75 0 00-1.5 0v2.25H9a.75.75 0 000 1.5h2.25V15a.75.75 0 001.5 0v-2.25H15a.75.75 0 000-1.5h-2.25V9z" clip-rule="evenodd" /></svg>
            智能推荐与建议
        </h2>
        <!-- 物联网数据推荐 -->
        <div id="iotRecommendSection" class="mb-6 p-4 border border-slate-700 rounded-md bg-slate-800/30">
          <h3 class="text-lg font-semibold text-blue-400 mb-3">作物智能推荐</h3>
          <button id="fetchApiBtn" class="w-full gradient-btn">
            <span class="button-text">获取传感器数据并推荐</span>
            <div class="loading-spinner hidden ml-2"></div>
        </button>
      </div>

      <!-- 选择作物和年龄获取建议 -->
        <div id="manualAdviceSection" class="p-4 border border-slate-700 rounded-md bg-slate-800/30">
          <h3 class="text-lg font-semibold text-blue-400 mb-3">专业施肥浇水建议</h3>
          <form id="cropAdviceForm" class="space-y-3">
          <div>
              <label for="crop_type" class="block text-sm font-medium text-slate-400 mb-1">选择作物</label>
              <select id="crop_type" name="crop_type" required>
                <option value="" disabled selected>请选择作物</option>
                <option value="Rice">水稻</option><option value="Maize">玉米</option><option value="ChickPea">鹰嘴豆</option>
                <option value="KidneyBeans">芸豆</option><option value="PigeonPeas">木豆</option><option value="MothBeans">蛾豆</option>
                <option value="MungBean">绿豆</option><option value="Blackgram">黑豆</option><option value="Lentil">扁豆</option>
                <option value="Pomegranate">石榴</option><option value="Banana">香蕉</option><option value="Mango">芒果</option>
                <option value="Grapes">葡萄</option><option value="Watermelon">西瓜</option><option value="Muskmelon">甜瓜</option>
                <option value="Apple">苹果</option><option value="Orange">橙子</option><option value="Papaya">木瓜</option>
                <option value="Coconut">椰子</option><option value="Cotton">棉花</option><option value="Jute">黄麻</option>
                <option value="Coffee">咖啡</option>
              </select>
          </div>
          <div>
              <label for="crop_age" class="block text-sm font-medium text-slate-400 mb-1">农作物年龄 (月)</label>
              <input type="number" id="crop_age" name="crop_age" step="0.1" min="0" required>
            </div>
            <button type="submit" id="submitAdviceBtn" class="w-full gradient-btn">
              <span class="button-text">获取施肥浇水建议</span>
              <div class="loading-spinner hidden ml-2"></div>
          </button>
        </form>
        </div>
      </div>

      <div class="panel">
        <h2 class="panel-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.75 12.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM7.5 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM8.25 17.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM9.75 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM10.5 17.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM12 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM12.75 17.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM14.25 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM15 17.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM16.5 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM12 13.5a.75.75 0 110-1.5.75.75 0 010 1.5zM4.5 9.75A.75.75 0 015.25 9h13.5a.75.75 0 010 1.5H5.25a.75.75 0 01-.75-.75zM5.25 6.75A.75.75 0 004.5 7.5v.061c.034.384.163.753.368 1.093l.002.003.002.003A2.232 2.232 0 006.75 9h10.5c.012 0 .023-.001.035-.002A2.239 2.239 0 0019.5 6.75c0-.799-.487-1.494-1.195-1.816l-.002-.001-.002-.002a2.253 2.253 0 00-2.077-.035l-.004.002A2.232 2.232 0 0013.5 6.75H9.75A2.25 2.25 0 007.5 4.5c0-.817.446-1.523 1.119-1.889l.004-.002A2.234 2.234 0 006.75 2.25H4.5C3.277 2.25 2.25 3.277 2.25 4.5v15A2.25 2.25 0 004.5 21.75h15A2.25 2.25 0 0021.75 19.5V12c0-.011 0-.023-.001-.034a2.24 2.24 0 00-1.5-2.215V6.75A2.25 2.25 0 0018 4.5h-2.25c-.012 0-.023.001-.035.002A2.239 2.239 0 0013.5 6.75H9.75A2.25 2.25 0 007.5 4.5c-.144 0-.285.013-.424.038l-.003.001A2.25 2.25 0 005.25 6.75z" /></svg>
            传感器数据趋势 (最近10条)
        </h2>
        <div class="chart-container">
          <canvas id="sensorDataChart"></canvas>
        </div>
         <div id="chartLoading" class="text-center py-3 hidden">
            <div class="loading-spinner inline-block"></div>
            <p class="mt-2 text-slate-400">正在加载图表数据...</p>
        </div>
        <p id="chartDataTimestamp" class="data-source-ts"></p>
      </div>
    </main>

    <!-- 右侧：结果显示面板 -->
    <aside class="panel results-panel">
      <h2 class="panel-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-2.432c.318.314.478.756.472 1.203a.75.75 0 01-.379.666l-.003.001-.002.002-.002.001a3.76 3.76 0 01-2.16.037c-.452-.113-.836-.303-1.152-.572a.75.75 0 11.904-1.205c.206.183.42.328.65.436a2.26 2.26 0 001.3.022c.19-.034.381-.1.57-.199.197-.102.38-.231.54-.385zM12.75 10.5a.75.75 0 011.5 0v4.5a.75.75 0 01-1.5 0v-4.5z" clip-rule="evenodd" /></svg>
          分析与建议详情
        </h2>
      <div id="llmResultsContainer">
        <!-- 实时传感器推荐结果 -->
        <div id="resultBox" class="hidden">
          <h3 class="text-xl font-semibold text-blue-300 mb-2">作物推荐结果</h3>
          <div id="currentSensorDataDisplay" class="mb-3 p-3 bg-slate-800/50 border border-slate-700 rounded text-sm">
            <!-- 传感器数据将填充这里 -->
          </div>
          <p class="mb-2 text-lg text-slate-300"><strong>推荐作物:</strong> <span id="cropNameDisplay" class="text-blue-400 font-bold"></span></p>
          <div class="mt-2">
            <h4 class="font-semibold text-blue-400">详细农业建议:</h4>
            <div id="adviceTextDisplay" class="mt-1 markdown-content"></div>
          </div>
           <p id="recommendDataTimestamp" class="data-source-ts"></p>
        </div>

        <!-- 物联网土壤数据建议结果 -->
        <div id="adviceResultBox" class="hidden">
          <h3 class="text-xl font-semibold text-blue-300 mb-2">施肥与浇水建议</h3>
          <p class="mb-1 text-lg text-slate-300"><strong>作物:</strong> <span id="adviceCropNameDisplay" class="text-blue-400 font-bold"></span></p>
          <p class="mb-3 text-lg text-slate-300"><strong>农作物年龄:</strong> <span id="adviceCropAgeDisplay" class="text-blue-400 font-bold"></span> 个月</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3 text-sm">
            <div class="bg-slate-800/50 p-3 rounded border border-indigo-500/30">
              <h4 class="font-semibold text-blue-400 mb-1">当前土壤条件</h4>
              <div id="currentConditionsDisplay"></div>
            </div>
            <div class="bg-slate-800/50 p-3 rounded border border-indigo-500/30">
              <h4 class="font-semibold text-blue-400 mb-1">理想土壤条件</h4>
              <div id="idealConditionsDisplay"></div>
            </div>
          </div>
          <div class="mt-2">
            <h4 class="font-semibold text-blue-400">详细专业建议:</h4>
            <div id="adviceTextManualDisplay" class="mt-1 markdown-content"></div>
        </div>
          <p id="manualAdviceDataTimestamp" class="data-source-ts"></p>
        </div>
         <p id="resultPlaceholder" class="text-slate-400">请在左侧选择操作以查看结果。</p>
      </div>
    </aside>
  </div>

  <script>
    // DOM Elements
    const weatherDisplay = document.getElementById('weatherDisplay');
    const weatherLoading = document.getElementById('weatherLoading');
    
    // 新增：预警功能DOM元素
    const warningCropTypeSelect = document.getElementById('warning_crop_type');
    const fetchWarningBtn = document.getElementById('fetchWarningBtn');
    const warningResultDisplay = document.getElementById('warningResultDisplay');
    const warningPlaceholder = document.getElementById('warningPlaceholder');

    const fetchApiBtn = document.getElementById('fetchApiBtn');
    const cropAdviceForm = document.getElementById('cropAdviceForm');
    const submitAdviceBtn = document.getElementById('submitAdviceBtn');

    const llmResultsContainer = document.getElementById('llmResultsContainer');
    const resultBox = document.getElementById('resultBox');
    const adviceResultBox = document.getElementById('adviceResultBox');
    const resultPlaceholder = document.getElementById('resultPlaceholder');

    // For crop recommendation
    const currentSensorDataDisplay = document.getElementById('currentSensorDataDisplay');
    const cropNameDisplay = document.getElementById('cropNameDisplay');
    const adviceTextDisplay = document.getElementById('adviceTextDisplay');
    const recommendDataTimestamp = document.getElementById('recommendDataTimestamp');


    // For manual advice
    const adviceCropNameDisplay = document.getElementById('adviceCropNameDisplay');
    const adviceCropAgeDisplay = document.getElementById('adviceCropAgeDisplay');
    const currentConditionsDisplay = document.getElementById('currentConditionsDisplay');
    const idealConditionsDisplay = document.getElementById('idealConditionsDisplay');
    const adviceTextManualDisplay = document.getElementById('adviceTextManualDisplay');
    const manualAdviceDataTimestamp = document.getElementById('manualAdviceDataTimestamp');

    // Chart elements
    const sensorDataChartCanvas = document.getElementById('sensorDataChart').getContext('2d');
    const chartLoading = document.getElementById('chartLoading');
    const chartDataTimestamp = document.getElementById('chartDataTimestamp');
    let sensorChart;

    // Loading state helpers
    function setLoading(buttonElement, isLoading) {
        const textElement = buttonElement.querySelector('.button-text');
        const spinnerElement = buttonElement.querySelector('.loading-spinner');
        if (isLoading) {
            buttonElement.disabled = true;
            textElement.style.display = 'none';
            spinnerElement.classList.remove('hidden');
        } else {
            buttonElement.disabled = false;
            textElement.style.display = 'inline';
            spinnerElement.classList.add('hidden');
        }
    }

    // Helper to show specific result panel
    function showResultPanel(panelToShow) {
        resultBox.classList.add('hidden');
        adviceResultBox.classList.add('hidden');
        resultPlaceholder.classList.add('hidden');
        if(panelToShow) {
            panelToShow.classList.remove('hidden');
        } else {
            resultPlaceholder.classList.remove('hidden');
        }
    }


    // --- Weather ---
    async function fetchWeather() {
      try {
        const res = await fetch("http://localhost:8000/api/weather"); // Add city query if needed
        const data = await res.json();
        weatherLoading.classList.add('hidden');

        if (data.error) {
          weatherDisplay.innerHTML = `<p class="text-red-400">天气加载失败: ${data.error}</p>`;
          return;
        }
        
        // 和风天气图标: https://dev.qweather.com/docs/resource/icons/
        // 你可能需要本地存储这些图标或者使用CDN (如果qweather-icons库能直接用class名的话)
        // 例如: <i class="qi-${data.icon}"></i>
        weatherDisplay.innerHTML = `
          <p class="text-2xl font-bold text-blue-300">${data.city_name_from_api || data.city || '未知地区'}</p>
          <i class="qi-${data.icon} weather-icon my-3 inline-block"></i>
          <p class="text-4xl font-semibold">${data.temperature}°C <span class="text-xl text-slate-400">(${data.description})</span></p>
          <p class="text-sm text-slate-400 mt-1">体感: ${data.feels_like}°C</p>
          <div class="mt-4 text-sm space-y-1 text-left">
            <p><strong>湿度:</strong> ${data.humidity}%</p>
            <p><strong>风向:</strong> ${data.wind_dir} (${data.wind_scale}级)</p>
            <p><strong>降水:</strong> ${data.precip} mm</p>
            <p><strong>气压:</strong> ${data.pressure} hPa</p>
            <p><strong>能见度:</strong> ${data.vis} km</p>
          </div>
          <p class="text-xs text-slate-500 mt-3">观测时间: ${new Date(data.obs_time).toLocaleString('zh-CN')}</p>
          ${data.api_status ? `<p class="text-xs text-yellow-500 mt-1">${data.api_status}</p>` : ''}
          ${data.fxLink ? `<p class="text-xs text-sky-400 mt-2"><a href="${data.fxLink}" target="_blank" rel="noopener noreferrer" class="hover:underline">查看详细天气预报 (和风天气)</a></p>` : ''}
        `;
      } catch (err) {
        weatherLoading.classList.add('hidden');
        weatherDisplay.innerHTML = `<p class="text-red-400">无法连接到天气服务。</p>`;
        console.error("Weather fetch error:", err);
      }
    }

    // --- Sensor Data Chart ---
    const chartColors = [ // 定义一些颜色用于图表的不同数据集
        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', 
        '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#22c55e'
    ];

    async function fetchAndRenderChart() {
      chartLoading.classList.remove('hidden');
      try {
        const res = await fetch("http://localhost:8000/api/sensor_chart_data");
        const json = await res.json();

        console.log("Chart API Response:", json); // 在浏览器控制台打印后端返回的图表数据

        if (json.error) {
          alert(`图表数据加载失败: ${json.error}`);
          chartLoading.classList.add('hidden');
          return;
        }
        
        const datasets = [];
        let colorIndex = 0;
        let primaryXAxisLabels = []; // 用于存储X轴的时间标签
        let xAxisLabelsSet = false;

        if (!json.chart_data || Object.keys(json.chart_data).length === 0) {
            alert("未获取到有效的图表数据内容 (chart_data 为空或不存在)。");
            chartLoading.classList.add('hidden');
            return;
        }

        for (const [sensorName, dataPoints] of Object.entries(json.chart_data)) {
          if(dataPoints && dataPoints.length > 0) {
            const data = dataPoints.map(dp => dp.value);
            const currentLabels = dataPoints.map(dp => 
                new Date(dp.time).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit'})
            );

            if (!xAxisLabelsSet) { // 使用第一个有数据的数据流的时间作为X轴标签
                primaryXAxisLabels = currentLabels;
                xAxisLabelsSet = true;
            }

            datasets.push({
              label: sensorName,
              data: data,
              borderColor: chartColors[colorIndex % chartColors.length],
              backgroundColor: chartColors[colorIndex % chartColors.length] + '33',
              tension: 0.3,
              fill: false,
              borderWidth: 2,
              pointRadius: 3,
              pointHoverRadius: 5
            });
            colorIndex++;
          } else {
            console.warn(`传感器 '${sensorName}' 没有数据点，将不会在图表中显示。`);
          }
        }
        
        if (datasets.length === 0) {
            alert("所有传感器均无有效数据点，无法生成图表。");
            chartLoading.classList.add('hidden');
            return;
        }

        if (sensorChart) {
          sensorChart.destroy(); 
        }

        sensorChart = new Chart(sensorDataChartCanvas, {
          type: 'line',
          data: {
            labels: primaryXAxisLabels, // 使用收集到的主要X轴时间标签
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index',
            },
            scales: {
              x: { 
                ticks: { color: '#9ca3af' }, 
                grid: { color: 'rgba(59, 130, 246, 0.1)' } 
              },
              y: { 
                ticks: { color: '#9ca3af' }, 
                grid: { color: 'rgba(59, 130, 246, 0.1)' },
                beginAtZero: false // Y轴不一定从0开始
              }
            },
            plugins: {
              legend: { 
                position: 'top',
                labels: { color: '#e0e0e0', boxWidth: 15, padding:15 }
              },
              tooltip: {
                backgroundColor: 'rgba(10, 25, 47, 0.85)',
                titleColor: '#e0e0e0',
                bodyColor: '#cbd5e1',
                borderColor: 'rgba(59, 130, 246, 0.5)',
                borderWidth: 1,
                padding: 10,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += context.parsed.y.toFixed(2);
                        }
                        return label;
                    }
                }
              }
            }
          }
        });
        chartDataTimestamp.textContent = `数据更新于: ${json.timestamp ? new Date(json.timestamp).toLocaleString('zh-CN') : 'N/A'}`;

      } catch (err) {
        alert("图表数据请求失败，请检查后端服务。");
        console.error("Chart data error:", err);
      } finally {
        chartLoading.classList.add('hidden');
      }
    }
    
    // 参数中英文对照 (与之前版本一致，可按需扩展)
    function getChineseLabel(key) {
      const labels = {
        "Nitrogen": "氮含量 (N)", "Phosphorus": "磷含量 (P)", "Potassium": "钾含量 (K)",
        "temperature": "温度", "humidity": "湿度", "ph": "pH值", "rainfall": "降水量",
        // 以下是API原始字段到中文的映射，用于显示传感器数据
        "tu_nitrogen": "土壤氮", "tu_phosphorus": "土壤磷", "tu_potassium": "土壤钾",
        "temp": "环境温度", "hum": "环境湿度", "yuliang": "降水量", "guangmin": "光照",
        "tu_humidity": "土壤湿度", "tu_ec": "土壤EC", "tu_temperature": "土壤温度", "tu_salt": "土壤盐分"
      };
      return labels[key] || key;
    }

    function getChineseCropName(englishName) {
      const cropNames = {
        "apple": "苹果", 
        "banana": "香蕉", 
        "blackgram": "黑豆", 
        "chickpea": "鹰嘴豆", 
        "coconut": "椰子", 
        "coffee": "咖啡", 
        "cotton": "棉花", 
        "grapes": "葡萄", 
        "jute": "黄麻", 
        "kidneybeans": "芸豆", // 注意：您的CSV和后端返回的可能是 "KidneyBeans" (首字母大写)，这里保持小写以匹配控制台日志中的键
        "lentil": "扁豆", 
        "maize": "玉米", 
        "mango": "芒果", 
        "mothbeans": "蛾豆", 
        "mungbean": "绿豆", 
        "muskmelon": "甜瓜", 
        "orange": "橙子", 
        "papaya": "木瓜", 
        "pigeonpeas": "木豆", 
        "pomegranate": "石榴", 
        "rice": "水稻", 
        "watermelon": "西瓜",
        // 根据您的截图，后端返回的作物名称键都是小写的，所以这里统一使用小写英文作为键
        // 如果后端在其他地方返回的作物名大小写不一致 (例如 "KidneyBeans" vs "kidneybeans")，
        // 我们可能需要在这里添加对应的项，或者在调用 getChineseCropName 之前统一处理大小写。
        // 为保险起见，也加上您最初列表中的一些大写开头的版本，以防万一，尽管后端目前似乎都用小写。
        "Rice": "水稻", "Maize": "玉米", "ChickPea": "鹰嘴豆", "KidneyBeans": "芸豆",
        "PigeonPeas": "木豆", "MothBeans": "蛾豆", "MungBean": "绿豆", "Blackgram": "黑豆", "Lentil": "扁豆",
        "Pomegranate": "石榴", "Banana": "香蕉", "Mango": "芒果", "Grapes": "葡萄", "Watermelon": "西瓜",
        "Muskmelon": "甜瓜", "Apple": "苹果", "Orange": "橙子", "Papaya": "木瓜", "Coconut": "椰子",
        "Cotton": "棉花", "Jute": "黄麻", "Coffee": "咖啡"
      };
      return cropNames[englishName] || englishName; // 如果找不到匹配，返回原英文名
    }
    
    // --- Crop Recommendation (via API) ---
    fetchApiBtn.addEventListener("click", async () => {
      setLoading(fetchApiBtn, true);
      showResultPanel(null); // Clear previous results

      try {
        const res = await fetch("http://localhost:8000/api_predict");
        const json = await res.json();

        if (json.error) {
          alert(`获取作物推荐失败: ${json.error}`);
          showResultPanel(null);
          return;
        }

        currentSensorDataDisplay.innerHTML = ""; // Clear previous sensor data
        let sensorDataHtml = '<ul class="list-disc list-inside text-xs">';
        for (const [key, value] of Object.entries(json.input_data)) {
          const formattedValue = typeof value === 'number' ? value.toFixed(2) : value;
          let unit = "";
          if (key === "temperature") unit = "°C";
          else if (key === "humidity") unit = "%";
          else if (key === "rainfall") unit = "mm";
          else if (key === "ph") unit = "";
          else unit = " mg/kg"; // Assuming N,P,K are in mg/kg or similar unit for soil

          sensorDataHtml += `<li><strong>${getChineseLabel(key)}:</strong> ${formattedValue}${unit}</li>`;
        }
        sensorDataHtml += '</ul>';
        currentSensorDataDisplay.innerHTML = sensorDataHtml;

        cropNameDisplay.textContent = getChineseCropName(json.predicted_crop);
        adviceTextDisplay.innerHTML = marked.parse(json.agricultural_advice);
        recommendDataTimestamp.textContent = `数据来源: ${json.data_source || "物联网"} @ ${json.timestamp ? new Date(json.timestamp).toLocaleString('zh-CN') : 'N/A'}`;
        showResultPanel(resultBox);

      } catch (err) {
        alert("请求作物推荐失败，请检查后端服务。");
        console.error("API predict error:", err);
        showResultPanel(null);
      } finally {
        setLoading(fetchApiBtn, false);
      }
    });

    // --- Crop Advice (Manual Form) ---
    cropAdviceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setLoading(submitAdviceBtn, true);
      showResultPanel(null); // Clear previous results

      const formData = new FormData(cropAdviceForm);
      const data = {
        crop_type: formData.get("crop_type"),
        crop_age: parseFloat(formData.get("crop_age"))
      };

      try {
        const res = await fetch("http://localhost:8000/crop_advice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        const json = await res.json();

        if (json.error) {
          alert(`获取施肥建议失败: ${json.error}`);
          showResultPanel(null);
          return;
        }

        adviceCropNameDisplay.textContent = getChineseCropName(json.crop_type);
        adviceCropAgeDisplay.textContent = json.crop_age.toFixed(1);

        currentConditionsDisplay.innerHTML = "";
        let currentCondHtml = '<ul class="list-disc list-inside">';
        for (const [key, value] of Object.entries(json.current_conditions)) {
          const formattedValue = typeof value === 'number' ? value.toFixed(2) : value;
          let unit = "";
          if (key === "temperature") unit = "°C";
          else if (key === "humidity") unit = "%";
          else if (key === "rainfall") unit = "mm";
          else if (key === "ph") unit = "";
          else unit = " mg/kg";
          currentCondHtml += `<li><strong>${getChineseLabel(key)}:</strong> ${formattedValue}${unit}</li>`;
        }
        currentCondHtml += '</ul>';
        currentConditionsDisplay.innerHTML = currentCondHtml;

        idealConditionsDisplay.innerHTML = "";
        let idealCondHtml = '<ul class="list-disc list-inside">';
        for (const [key, value] of Object.entries(json.ideal_conditions)) {
          const formattedValue = typeof value === 'number' ? value.toFixed(2) : value;
          let unit = "";
          if (key === "temperature") unit = "°C";
          else if (key === "humidity") unit = "%";
          else if (key === "rainfall") unit = "mm";
          else if (key === "ph") unit = "";
          else unit = " mg/kg";
          idealCondHtml += `<li><strong>${getChineseLabel(key)}:</strong> ${formattedValue}${unit}</li>`;
        }
        idealCondHtml += '</ul>';
        idealConditionsDisplay.innerHTML = idealCondHtml;
        
        adviceTextManualDisplay.innerHTML = marked.parse(json.agricultural_advice);
        manualAdviceDataTimestamp.textContent = `数据来源: ${json.data_source || "物联网"} @ ${json.timestamp ? new Date(json.timestamp).toLocaleString('zh-CN') : 'N/A'}`;
        showResultPanel(adviceResultBox);

      } catch (err) {
        alert("请求施肥建议失败，请检查后端服务。");
        console.error("Crop advice error:", err);
        showResultPanel(null);
      } finally {
        setLoading(submitAdviceBtn, false);
      }
    });

    // --- 新增：作物环境预警功能 JS ---
    async function populateCropWarningSelect() {
        try {
            const response = await fetch('http://localhost:8000/api/crop_names');
            const data = await response.json();
            if (data.crop_names && data.crop_names.length > 0) {
                warningCropTypeSelect.innerHTML = '<option value="" disabled selected>请选择作物</option>'; // Reset
                data.crop_names.forEach(crop => {
                    const option = document.createElement('option');
                    option.value = crop;
                    const chineseName = getChineseCropName(crop);
                    option.textContent = chineseName;
                    console.log(`Mapping crop: ${crop} -> ${chineseName}`); // 调试信息
                    warningCropTypeSelect.appendChild(option);
                });
            } else {
                warningCropTypeSelect.innerHTML = '<option value="" disabled selected>无可用作物数据</option>';
                console.error("作物列表为空或加载失败: ", data.detail || "未知错误");
            }
        } catch (error) {
            warningCropTypeSelect.innerHTML = '<option value="" disabled selected>加载作物失败</option>';
            console.error('获取作物列表失败:', error);
        }
    }

    fetchWarningBtn.addEventListener('click', async () => {
        const selectedCrop = warningCropTypeSelect.value;
        if (!selectedCrop) {
            alert('请先选择一个作物种类。');
            return;
        }

        setLoading(fetchWarningBtn, true);
        warningPlaceholder.classList.add('hidden');
        warningResultDisplay.innerHTML = '<div class="loading-spinner inline-block"></div> <span class="ml-2">正在获取预警信息...</span>';

        try {
            const response = await fetch(`http://localhost:8000/api/crop_warning?crop_type=${encodeURIComponent(selectedCrop)}`);
            const data = await response.json();
            
            let resultHTML = '';
            if (response.ok) {
                let levelClass = 'text-slate-300'; // Default
                if (data.assessment.level === 'Good') levelClass = 'text-green-400';
                else if (data.assessment.level === 'Warning') levelClass = 'text-yellow-400';
                else if (data.assessment.level === 'Critical') levelClass = 'text-red-500';
                else if (data.assessment.level === 'Error') levelClass = 'text-red-400';

                resultHTML += `<h4 class="font-semibold text-blue-300 mb-2">预警评估: ${getChineseCropName(data.crop_type)} <span class="${levelClass}">(${data.assessment.level})</span></h4>`;
                const assessmentMessage = data.assessment.message.replace(/\\n|\n/g, '<br>');
                resultHTML += `<p class="mb-3 ${levelClass}">${assessmentMessage}</p>`;

                resultHTML += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs mb-3">';
                // 当前条件
                resultHTML += '<div class="bg-slate-700/50 p-2 rounded">';
                resultHTML += '<h5 class="font-semibold text-sky-400 mb-1">当前环境条件:</h5><ul class="list-disc list-inside">';
                if (data.current_conditions) {
                    for (const [key, value] of Object.entries(data.current_conditions)) {
                        resultHTML += `<li><strong>${key}:</strong> ${value}</li>`;
                    }
                } else {
                    resultHTML += '<li>无法获取当前条件数据。</li>';
                }
                resultHTML += '</ul></div>';

                // 理想条件
                resultHTML += '<div class="bg-slate-700/50 p-2 rounded">';
                resultHTML += '<h5 class="font-semibold text-emerald-400 mb-1">理想环境条件:</h5><ul class="list-disc list-inside">';
                if (data.ideal_conditions) {
                    for (const [key, value] of Object.entries(data.ideal_conditions)) {
                        resultHTML += `<li><strong>${key}:</strong> ${value}</li>`;
                    }
                } else {
                    resultHTML += '<li>无法获取理想条件数据。</li>';
                }
                resultHTML += '</ul></div></div>';

                // 偏差详情
                if (data.deviations) {
                    resultHTML += '<h5 class="font-semibold text-orange-400 mb-1 mt-3">参数偏差详情:</h5>';
                    resultHTML += '<div class="space-y-1 text-xs">';
                    for (const [param, details] of Object.entries(data.deviations)) {
                        let statusColor = 'text-slate-400';
                        if (details.status === 'Good') statusColor = 'text-green-500';
                        else if (details.status === 'Warning') statusColor = 'text-yellow-500';
                        else if (details.status === 'Critical') statusColor = 'text-red-600';
                        else if (details.status === 'Data missing') statusColor = 'text-orange-500';
                        
                        resultHTML += `<div class="p-1.5 bg-slate-900 rounded"><strong class="${statusColor}">${param}:</strong> Ideal: ${details.ideal}, Current: ${details.current}, Diff: ${details.diff_percent} <span class="font-semibold">(${details.status})</span></div>`;
                    }
                    resultHTML += '</div>';
                }
                resultHTML += `<p class="text-xs text-slate-500 mt-2">数据时间: ${new Date(data.timestamp).toLocaleString('zh-CN')}</p>`;

            } else { // HTTP error (e.g., 404, 500)
                 let errorMsg = data.detail || `请求失败，状态码: ${response.status}`;
                 resultHTML = `<p class="text-red-400">获取预警信息失败: ${errorMsg}</p>`;
            }
            warningResultDisplay.innerHTML = resultHTML;
        } catch (error) {
            console.error('获取预警信息错误:', error);
            warningResultDisplay.innerHTML = `<p class="text-red-400">获取预警信息时发生客户端错误: ${error.message}</p>`;
        }
        finally {
            setLoading(fetchWarningBtn, false);
        }
    });
    // --- 作物环境预警功能 JS 结束 ---

    // Initial calls on page load
    document.addEventListener('DOMContentLoaded', () => {
      fetchWeather();
      fetchAndRenderChart();
      showResultPanel(null); // Initially show placeholder
      populateCropWarningSelect(); // 新增：页面加载时填充预警作物下拉框
    });
  </script>
</body>
</html>